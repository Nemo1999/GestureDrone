<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <script src="/socket.io/socket.io.js"></script>
    
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
    
    <title>Aframe App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>    
    <a-scene>
    
	<a-box id="box" rotation="0 0 0" position="0 1.3 -1" depth="0.5" height="0.3" width="0.5"  color="#EF2D5E"></a-box>
    
      
      <a-entity id="translate"  position="-0.08 1.5 -1.5">
	<a-entity scale="5 5 5">
	  <a-entity id="text" text="value: Hello World; color: #EF2D5E"  ></a-entity>
	</a-entity>
      </a-entity>     

      
      <a-entity id="rotate-controller" rotation="0 0 0">
	<a-entity id="rotateY" rotation="0 0 0"> 
	  <a-entity id="translate-controller"  position="-1 -2 0">
	    <a-entity environment="preset: forest;"></a-entity>
	    
            <a-sky color="#ECECEC"></a-sky>
	    
	  </a-entity>
	</a-entity>
      </a-entity>
    </a-scene>
    <script type="text/javascript" src="script_for_aframe.js">
      let Sensors = {humd:80,gyro:{x:0,y:0,z:0},acc:{x:0,y:0,z:0},temp:28};
      let reset = false;
      let BiasAng = {Bx:0,By:0,Bz:0};
      let angY = 0;

      //reset the bias angle with enter key.
      const handleKeyDown = e =>  {   
	if (e.key === 'Enter') {
	    reset = true;
	    //console.log('reset');
	}
      }
      window.addEventListener("keydown",handleKeyDown);
      

      
      var socket = io();
     
      
      socket.on("update_data", (data) => {
	  let  diff
	  console.log(data);
	  try {
	      diff = JSON.parse(data);
	  }
	  catch(e){
	      console.log("parse error");
	  }
	  Sensors =  ({...Sensors,...diff});
	  //console.log(diff);
	  //console.log(Sensors);


	  //------------ Joy stick ------------





	  updateView();
	  if(reset){
	      BiasAng = {
		  Bx: Sensors.gyro.x,
		  By: Sensors.gyro.y,
		  Bz: Sensors.gyro.z
	      }
	      reset = false;
	      
	  }
      });
      
	  
      // A-frame
      //const entityEl = document.querySelector("a-entity");
      const sceneEl = document.querySelector("a-scene");
      const translateController = sceneEl.querySelector("#translate-controller");
      const rotateController = sceneEl.querySelector("#rotate-controller");
      const rotateY = sceneEl.querySelector("#rotateY");
      const textController = sceneEl.querySelector("#text");
      
      //const viewController = entityEl.querySelector("#camera");
      //const box = sceneEl.querySelector("#box");
      

      const updateView = () => {

	  //console.log(textController.getAttribute("text"));
	  //console.log()
	  textController.setAttribute("text",`value:${"Temp:"+ Math.round(Sensors.temp * 100)/100+"\nHumid:"+(Math.round(Sensors.humd*100)/100)};color:#EF2D5E`);
	  
	  const Wx = Sensors.gyro.x - BiasAng.Bx;
	  const Wy = Sensors.gyro.y - BiasAng.By;
	  const Wz = Sensors.gyro.z - BiasAng.Bz;
	  const rot = rotateController.getAttribute("rotation");
	  //console.log([rot.x,rot.y,rot.z]);
	  if(Wz>10)
	      angY += 2;
	  else if (Wz < -10)
	      angY -= 2;
	  else
	      ;

	  
	  //angY = -\Wz;
	  
	  rotateY.setAttribute("rotation",{x:0,y:angY,z:0});
	  rotateController.setAttribute("rotation", { x: Wx, y:0 , z: -Wy });
	  // box.setAttribute("rotation", { x: Wx, y: Wy, z: Wz });
	  const { x, y, z } = translateController.getAttribute("position");
	  //console.log([x,y,z]);
	  let  dx1 = 0;
	  let  dy1 = 0;
	  let  dx2 = 0;
	  let  dy2 = 0;
	  if(Math.abs(Wy)>10){
	      dx1 = Math.cos(angY/180*Math.PI)*0.05 * Math.sign(Wy)*Math.min(3,Math.abs(Wy));
	      dy1 = Math.sin(angY/180*Math.PI)*0.05 * Math.sign(Wy)*Math.min(3,Math.abs(Wy));
	  }
	  if(Math.abs(Wx)>10){
	      dx2 = Math.cos(angY/180*Math.PI+Math.PI/2)*0.05 * Math.sign(Wx)*Math.min(3,Math.abs(Wx));
	      dy2 = Math.sin(angY/180*Math.PI+Math.PI/2)*0.05 * Math.sign(Wx)*Math.min(3,Math.abs(Wx));
	  }
	  
	  translateController.setAttribute("position", {
	      x: x + dx1 + dx2,
	      y: -2.5,//-Pz
	      z: z + dy1 + dy2
	  });
      };
    </script>
  </body>
</html>
